const editor = document.getElementById('editor');
const background = document.getElementById('notes-background');

// ── Clear placeholder on first click ──
editor.addEventListener('focus', () => {
  if (editor.innerText.trim() === 'Start typing here...') {
    editor.innerHTML = '<p></p>';
  }
});

// ── FONT SIZE PICKER ──
document.getElementById('font-size-picker').addEventListener('change', (e) => {
  editor.style.fontSize = e.target.value;
});

// ── Helper: create a todo item ──
function createTodoItem() {
  const div = document.createElement('div');
  div.className = 'todo-item';
  div.setAttribute('data-type', 'todo');

  const box = document.createElement('span');
  box.className = 'todo-checkbox';
  box.addEventListener('click', () => {
    const isDone = box.getAttribute('data-done') === 'true';
    box.setAttribute('data-done', !isDone);
    box.textContent = !isDone ? '★' : '';
  });

  const text = document.createElement('span');
  text.className = 'todo-text';
  text.contentEditable = 'true';

  // Enter key creates a new todo item
  text.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const newTodo = createTodoItem();
      div.parentNode.insertBefore(newTodo, div.nextSibling);
      newTodo.querySelector('.todo-text').focus();
    }
    // Backspace on empty text removes the todo item
    if (e.key === 'Backspace' && text.innerText.trim() === '') {
      e.preventDefault();
      const prev = div.previousSibling;
      div.remove();
      if (prev) {
        const prevText = prev.querySelector('.todo-text, .bullet-text');
        if (prevText) {
          prevText.focus();
        }
      }
    }
  });

  div.appendChild(box);
  div.appendChild(text);
  return div;
}

// ── Helper: create a bullet item ──
function createBulletItem() {
  const div = document.createElement('div');
  div.className = 'bullet-item';
  div.setAttribute('data-type', 'bullet');

  const dot = document.createElement('span');
  dot.className = 'bullet-dot';

  const text = document.createElement('span');
  text.className = 'bullet-text';
  text.contentEditable = 'true';

  // Enter key creates a new bullet item
  text.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const newBullet = createBulletItem();
      div.parentNode.insertBefore(newBullet, div.nextSibling);
      newBullet.querySelector('.bullet-text').focus();
    }
    // Backspace on empty text removes the bullet item
    if (e.key === 'Backspace' && text.innerText.trim() === '') {
      e.preventDefault();
      const prev = div.previousSibling;
      div.remove();
      if (prev) {
        const prevText = prev.querySelector('.todo-text, .bullet-text');
        if (prevText) {
          prevText.focus();
        }
      }
    }
  });

  div.appendChild(dot);
  div.appendChild(text);
  return div;
}

// ── TO-DO BUTTON ──
document.getElementById('btn-todo').addEventListener('click', () => {
  const todo = createTodoItem();
  editor.appendChild(todo);
  todo.querySelector('.todo-text').focus();
});

// ── BULLET BUTTON ──
document.getElementById('btn-bullet').addEventListener('click', () => {
  const bullet = createBulletItem();
  editor.appendChild(bullet);
  bullet.querySelector('.bullet-text').focus();
});

// ── PUBLISH BUTTON ──
document.getElementById('btn-publish').addEventListener('click', () => {
  const content = editor.innerHTML.trim();
  if (!content || content === '<p></p>' || content === '<p><br></p>') return;

  const note = document.createElement('div');
  note.className = 'published-note retro-window';

  const titlebar = document.createElement('div');
  titlebar.className = 'retro-titlebar';
  titlebar.innerHTML = `
    <span class="retro-title">note</span>
    <div class="retro-controls">
      <span class="close-btn">✕</span>
    </div>
  `;
  titlebar.querySelector('.close-btn').addEventListener('click', () => note.remove());

  const noteContent = document.createElement('div');
  noteContent.className = 'retro-content';
  noteContent.innerHTML = content;

  // Re-attach checkbox events on published notes
  noteContent.querySelectorAll('.todo-checkbox').forEach(box => {
    box.addEventListener('click', () => {
      const isDone = box.getAttribute('data-done') === 'true';
      box.setAttribute('data-done', !isDone);
      box.textContent = !isDone ? '★' : '';
    });
  });

  note.appendChild(titlebar);
  note.appendChild(noteContent);

  // Random position
  const bgW = background.clientWidth;
  const bgH = background.clientHeight;
  const x = Math.random() * (bgW - 240);
  const y = Math.random() * (bgH - 200);
  note.style.left = x + 'px';
  note.style.top  = y + 'px';

  background.appendChild(note);
  makeDraggable(note, titlebar);

  // Clear editor
  editor.innerHTML = '<p></p>';
  editor.focus();
});

// ── DRAGGABLE ──
function makeDraggable(el, handle) {
  let startX, startY, startL, startT;

  handle.addEventListener('mousedown', e => {
    startX = e.clientX;
    startY = e.clientY;
    startL = parseInt(el.style.left) || 0;
    startT = parseInt(el.style.top)  || 0;
    el.style.cursor = 'grabbing';

    function onMove(e) {
      el.style.left = (startL + e.clientX - startX) + 'px';
      el.style.top  = (startT + e.clientY - startY) + 'px';
    }

    function onUp() {
      el.style.cursor = 'grab';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}
